from typing import Optional

from commands2 import Subsystem
from phoenix6.orchestra import Orchestra
from wpilib import SendableChooser, SmartDashboard


class OrchestraSubsystem(Subsystem):

    def __init__(
        self,
        driveSubsystem,
        climberSubsystem: Optional[Subsystem] = None,
        shooterSubsystem: Optional[Subsystem] = None,
    ):
        super().__init__()

        self._orchestra = Orchestra()
        self._current_song: Optional[str] = None
        self._championship_mode = False
        self._championship_song_path = (
            "/home/lvuser/py/deploy/files/WinnerSong.chrp"
        )

        # Register motors
        for subsystem in (
            driveSubsystem,
            climberSubsystem,
            shooterSubsystem,
        ):
            if subsystem is None:
                continue

            for motor in subsystem.getMotors():
                self._orchestra.add_instrument(motor)

        # Song Chooser

        self._song_chooser = SendableChooser()

        self._song_chooser.setDefaultOption(
            "Yes And? - Ariana Grande",
            "/home/lvuser/py/deploy/files/Yesand.chrp"
        )

        self._song_chooser.addOption(
            "Espresso - Sabrina Carpenter",
            "/home/lvuser/py/deploy/files/Espresso.chrp"
        )

        self._song_chooser.addOption(
            "Needy - Ariana Grande",
            "/home/lvuser/py/deploy/files/Needy.chrp"
        )

        self._song_chooser.addOption(
            "Dandelion - Ariana Grande",
            "/home/lvuser/py/deploy/files/Dandelion.chrp"
        )

        self._song_chooser.addOption(
            "When Did You Get Hot - Sabrina Carpenter",
            "/home/lvuser/py/deploy/files/WhenDidYouGetHot.chrp"
        )

        self._song_chooser.addOption(
            "Tití Me Preguntó - Bad Bunny",
            "/home/lvuser/py/deploy/files/TitiMePregunto.chrp"
        )

        self._song_chooser.addOption(
            "Stateside - PinkPantheress",
            "/home/lvuser/py/deploy/files/Stateside.chrp"
        )

        self._song_chooser.addOption(
            "Despacito - Luis Fonsi",
            "/home/lvuser/py/deploy/files/Despacito.chrp"
        )

        SmartDashboard.putData("Song Selection", self._song_chooser)

    # Public API

    def play_selected_song(self):
        path = self._song_chooser.getSelected()

        if path is None:
            return

        if self._current_song != path:
            self._orchestra.load_music(path)
            self._current_song = path

        if not self._orchestra.is_playing():
            self._orchestra.play()

    def play_championship_song(self):

        if not self._championship_enabled:
            print("[Orchestra] Championship mode not enabled.")
            return

        path = self._championship_song_path

        if self._current_song != path:
            self._orchestra.load_music(path)
            self._current_song = path

        if not self._orchestra.is_playing():
            self._orchestra.play()


    def stop(self):
        self._orchestra.stop()

    def is_playing(self) -> bool:
        return self._orchestra.is_playing()
